# Elestio Configuration for Claude Insights Server
# This file configures routing for Elestio deployment
# Local development uses docker-compose.yml ports directly

config:
  runTime: "docker-compose"
  version: ""

# Environment variables - set these in Elestio dashboard
# DB_PASSWORD: Strong database password
# API_SECRET_KEY: Random 32+ character string
# FLASK_SECRET_KEY: Random 32+ character string

ports:
  # API (FastAPI) - Main endpoint for session uploads
  # Elestio routes 443 â†’ 3000 by default
  - protocol: "HTTPS"
    targetProtocol: "HTTP"
    listeningPort: "443"
    targetPort: "3000"
    targetIP: "172.17.0.1"
    public: true
    path: "/"
    isAuth: false
    login: ""
    password: ""

  # Dashboard - Team statistics UI
  # Exposed directly on port 8443
  - protocol: "HTTPS"
    targetProtocol: "HTTP"
    listeningPort: "8443"
    targetPort: "8443"
    targetIP: "172.17.0.1"
    public: true
    path: "/"
    isAuth: false
    login: ""
    password: ""

# PostgreSQL is NOT exposed - internal only
# Exporter runs as background service - no port needed

lifeCycle:
  postInstallCommand: |
    # Generate .env if it doesn't exist
    if [ ! -f .env ]; then
      echo "Generating secure environment variables..."
      cat > .env << ENVEOF
    DB_PASSWORD=$(openssl rand -hex 16)
    API_SECRET_KEY=$(openssl rand -hex 32)
    FLASK_SECRET_KEY=$(openssl rand -hex 32)
    ENVEOF
      echo "Created .env with secure credentials."
    fi

    # Restart containers to pick up env vars
    docker compose down 2>/dev/null || true
    docker compose up -d

    echo ""
    echo "Claude Insights Server deployed successfully!"
    echo ""
    echo "Create your first user:"
    echo "  docker compose exec api python -m app.cli create-user <username> --email <email>"
    echo ""
    echo "Access:"
    echo "  API: https://[CI_CD_DOMAIN]"
    echo "  Dashboard: https://[CI_CD_DOMAIN]:8443"

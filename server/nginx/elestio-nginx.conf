#CVE-2025-55182 Mitigation
map $http_next_action $has_next_action {
    default 0;
    "~.+"   1;
}
map $http_rsc_action_id $has_rsc_action {
    default 0;
    "~.+"   1;
}

map $content_type $is_form_content {
    default                              0;
    "~*^multipart/form-data"             1;
    "~*^application/x-www-form-urlencoded" 1;
}
map "$has_next_action$has_rsc_action" $has_rsc_header {
    default 0;
    "~1"    1;  # Any "1" in string means at least one matched
}
map "$has_rsc_header$is_form_content" $is_rsc_form_request {
    default 0;
    "11"    1;  # Both must be 1
}

map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

proxy_cache_path /tmp/claude-insights levels=1:2 keys_zone=claude-insights:10m max_size=1g inactive=60m use_temp_path=off;
limit_req_zone $binary_remote_addr$http_x_forwarded_for zone=claude-insightse:16m rate=1000000r/m;



server {
  listen 443 ssl;
  http2 on;
  ssl_certificate /etc/nginx/certs/cert.pem;
  ssl_certificate_key /etc/nginx/certs/key.pem;
  server_name claude-insights-u1128.vm.elestio.app;

  client_header_buffer_size 32k;
  large_client_header_buffers 4 64k;
  underscores_in_headers on;

  #access_log  /var/log/nginx/access_log;
  #error_log /var/log/nginx/error_log;

  include /usr/local/openresty/nginx/conf/error-pages.conf;

  # Dashboard - Team statistics UI
  location /dashboard/ {
    proxy_pass http://172.17.0.1:8081/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_http_version 1.1;
  }

  # API - FastAPI application
  location / {

    content_by_lua_block {
        ngx.header['server'] = 'Elestio'
    }
    access_by_lua_block {
        ngx.header['server'] = 'Elestio'
    }


    if ($is_rsc_form_request) {
      return 403;
    }




    limit_req zone=claude-insightse burst=1000000 nodelay;
    limit_req_log_level warn;



    add_header X-Cache-Status $upstream_cache_status;
    proxy_ignore_headers Cache-Control;

    #proxy_cache_valid any 0s;
    #proxy_cache claude-insights;
    #proxy_cache_lock on;
    #proxy_cache_methods GET HEAD;
    #proxy_cache_bypass $cookie_nocache $arg_nocache;
    #proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    #proxy_cache_bypass $http_upgrade;

    # Connection & timeout handling
    proxy_read_timeout 180s;
    proxy_send_timeout 180s;
    proxy_connect_timeout 180s;
    keepalive_timeout 180s;

    proxy_http_version 1.1;
    proxy_pass http://172.17.0.1:3000/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port  $server_port;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Authorization $http_authorization;
    proxy_pass_header  Authorization;

    proxy_hide_header x-powered-by;

  }
}
